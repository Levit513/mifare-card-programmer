{% extends "base.html" %}

{% block title %}Receive Program - MIFARE System{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        <div class="card shadow">
            <div class="card-header text-center bg-primary text-white">
                <h4><i class="fas fa-mobile-alt me-2"></i>MIFARE Card Programming</h4>
            </div>
            <div class="card-body">
                <div class="text-center mb-4">
                    <h5>{{ program.name }}</h5>
                    <p class="text-muted">{{ program.description or 'Ready to program your MIFARE card' }}</p>
                </div>

                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Important:</strong> This programming link can only be used once and will expire after use.
                </div>

                <div class="card mb-4">
                    <div class="card-header">
                        <h6><i class="fas fa-list me-2"></i>Instructions</h6>
                    </div>
                    <div class="card-body">
                        <ol class="mb-0">
                            <li>Ensure your Android device has NFC enabled</li>
                            <li>Click "Start Programming" below</li>
                            <li>Hold your MIFARE card against the back of your phone</li>
                            <li>Wait for programming to complete</li>
                            <li>Remove the card when prompted</li>
                        </ol>
                    </div>
                </div>

                <div id="programmingInterface" style="display: none;">
                    <div class="text-center mb-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Preparing card data...</p>
                    </div>
                    
                    <div id="nfcInterface" style="display: none;">
                        <div class="alert alert-info text-center">
                            <i class="fas fa-wifi fa-2x mb-3"></i>
                            <h5>Place MIFARE card on NFC area</h5>
                            <p class="mb-0">Hold the card steady against your phone's NFC area</p>
                        </div>
                        
                        <div class="progress mb-3">
                            <div class="progress-bar" role="progressbar" style="width: 0%" id="progressBar"></div>
                        </div>
                        
                        <div id="statusText" class="text-center">
                            <small class="text-muted">Waiting for card...</small>
                        </div>
                    </div>
                    
                    <div id="successMessage" class="alert alert-success text-center" style="display: none;">
                        <i class="fas fa-check-circle fa-2x mb-3"></i>
                        <h5>Programming Complete!</h5>
                        <p class="mb-0">Your MIFARE card has been successfully programmed.</p>
                    </div>
                    
                    <div id="errorMessage" class="alert alert-danger text-center" style="display: none;">
                        <i class="fas fa-times-circle fa-2x mb-3"></i>
                        <h5>Programming Failed</h5>
                        <p class="mb-0" id="errorText">An error occurred during programming.</p>
                    </div>
                </div>

                <div class="d-grid" id="startButton">
                    <button class="btn btn-primary btn-lg" onclick="startProgramming()">
                        <i class="fas fa-play me-2"></i>Start Programming
                    </button>
                </div>
                
                <div class="text-center mt-3">
                    <small class="text-muted">
                        <i class="fas fa-shield-alt me-1"></i>
                        Secure one-time programming â€¢ Token: {{ distribution.access_token[:8] }}...
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let programmingData = null;
let nfcSupported = false;

// Check for NFC support
document.addEventListener('DOMContentLoaded', function() {
    if ('NDEFReader' in window) {
        nfcSupported = true;
    } else {
        console.log('NFC not supported on this device');
    }
});

async function startProgramming() {
    document.getElementById('startButton').style.display = 'none';
    document.getElementById('programmingInterface').style.display = 'block';
    
    try {
        // Fetch programming data
        const response = await fetch('/api/program_data/{{ distribution.access_token }}');
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to fetch programming data');
        }
        
        programmingData = await response.json();
        
        // Hide loading, show NFC interface
        document.querySelector('.spinner-border').parentElement.style.display = 'none';
        document.getElementById('nfcInterface').style.display = 'block';
        
        // Debug: Log the programming data structure
        console.log('Programming data received:', programmingData);
        console.log('Sector data structure:', programmingData.sector_data);
        
        // Start NFC programming
        if (nfcSupported) {
            await startNFCProgramming();
        } else {
            // Fallback for browsers without NFC support
            await simulateProgramming();
        }
        
    } catch (error) {
        showError('Failed to load programming data: ' + error.message);
    }
}

async function startNFCProgramming() {
    try {
        const ndef = new NDEFReader();
        
        // Request NFC permission first
        await ndef.scan();
        
        updateStatus('Hold your MIFARE card near the device...');
        
        ndef.addEventListener('reading', async (event) => {
            updateStatus('Card detected! Programming...');
            
            try {
                // Stop scanning to prevent interference
                ndef.addEventListener('reading', () => {});
                
                // Program each sector with delay between writes
                const sectors = Object.entries(programmingData.sector_data);
                console.log(`Programming ${sectors.length} sectors:`, sectors.map(([num, data]) => `Sector ${num}: ${data.blocks?.length || 0} blocks`));
                
                for (let i = 0; i < sectors.length; i++) {
                    const [sectorNum, sectorData] = sectors[i];
                    updateStatus(`Programming sector ${sectorNum}...`);
                    
                    // Validate sector data before writing
                    if (!sectorData.blocks || sectorData.blocks.length === 0) {
                        console.warn(`Sector ${sectorNum} has no block data, skipping`);
                        continue;
                    }
                    
                    // Special handling for sector 0 - warn about manufacturer block
                    if (parseInt(sectorNum) === 0) {
                        console.log(`Programming sector 0 - manufacturer block protection active`);
                    }
                    
                    console.log(`Programming sector ${sectorNum} with ${sectorData.blocks.length} blocks`);
                    await writeMifareSector(parseInt(sectorNum), sectorData);
                    
                    // Add delay between sector writes
                    if (i < sectors.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                    
                    updateProgress(((i + 1) / sectors.length) * 100);
                }
                
                updateStatus('Programming complete!');
                updateProgress(100);
                
                // Mark programming as successful in database
                await markProgrammingSuccess();
                
                // Show success
                document.getElementById('nfcInterface').style.display = 'none';
                document.getElementById('successMessage').style.display = 'block';
                
            } catch (error) {
                throw new Error(`MIFARE programming failed: ${error.message}`);
            }
        });
        
    } catch (error) {
        updateStatus(`Programming failed: ${error.message}`);
        console.error('NFC Programming error:', error);
    }
}

async function writeMifareSector(sectorNum, sectorData) {
    // Create NDEF record for MIFARE sector data
    const ndef = new NDEFReader();
    
    // Prepare sector data for writing
    const blocks = sectorData.blocks || [];
    const keys = sectorData.keys || { keyA: 'FFFFFFFFFFFF', keyB: 'FFFFFFFFFFFF' };
    
    console.log(`Writing sector ${sectorNum} with data:`, sectorData);
    
    try {
        // Convert MIFARE block data to binary format for proper programming
        const records = [];
        
        // Add each block as a binary record
        for (let blockNum = 0; blockNum < blocks.length; blockNum++) {
            // Skip sector 0, block 0 (manufacturer block) unless explicitly programmed
            if (sectorNum === 0 && blockNum === 0) {
                // Check if block 0 has been explicitly modified from default
                const blockData = blocks[blockNum];
                if (!blockData || blockData === '' || blockData === '00000000000000000000000000000000') {
                    console.log(`Skipping sector 0, block 0 (manufacturer block) - not explicitly programmed`);
                    continue;
                }
                console.log(`Programming sector 0, block 0 - explicitly set with data: ${blockData}`);
            }
            
            const blockData = blocks[blockNum];
            if (blockData && blockData.length === 32) { // 32 hex chars = 16 bytes
                // Convert hex string to Uint8Array
                const bytes = new Uint8Array(
                    blockData.match(/.{2}/g).map(byte => parseInt(byte, 16))
                );
                
                records.push({
                    recordType: "application/octet-stream",
                    data: bytes,
                    id: `mifare_s${sectorNum}_b${blockNum}`
                });
                
                console.log(`Block ${blockNum}: ${blockData} -> [${Array.from(bytes).join(', ')}]`);
            }
        }
        
        // Add sector keys as metadata
        const keyData = JSON.stringify({
            sector: sectorNum,
            keyA: keys.keyA,
            keyB: keys.keyB,
            blockCount: blocks.length
        });
        
        records.push({
            recordType: "text",
            data: keyData,
            id: `mifare_s${sectorNum}_keys`
        });
        
        const message = { records };
        
        await ndef.write(message);
        console.log(`Successfully wrote sector ${sectorNum} with ${blocks.length} blocks`);
        
    } catch (error) {
        console.error(`Failed to write sector ${sectorNum}:`, error);
        // Provide more specific error information
        if (error.name === 'NotAllowedError') {
            throw new Error('NFC permission denied. Please allow NFC access.');
        } else if (error.name === 'NotSupportedError') {
            throw new Error('NFC not supported on this device or browser.');
        } else if (error.name === 'NotReadableError') {
            throw new Error('NFC card not readable. Try repositioning the card.');
        } else {
            throw new Error(`NFC write failed: ${error.message || 'Unknown error'}`);
        }
    }
}

async function simulateProgramming() {
    // Fallback simulation for non-NFC browsers
    updateStatus('Simulating programming (NFC not available)...');
    
    return new Promise(async (resolve) => {
        let progress = 0;
        const interval = setInterval(async () => {
            progress += 10;
            updateProgress(progress);
            
            if (progress >= 100) {
                clearInterval(interval);
                updateStatus('Simulation complete!');
                
                // Mark programming as successful in database
                await markProgrammingSuccess();
                
                // Show success
                document.getElementById('nfcInterface').style.display = 'none';
                document.getElementById('successMessage').style.display = 'block';
                resolve();
            }
        }, 200);
    });
}

function updateProgress(percent) {
    document.getElementById('progressBar').style.width = percent + '%';
}

function updateStatus(text) {
    document.getElementById('statusText').innerHTML = `<small class="text-muted">${text}</small>`;
}

async function markProgrammingSuccess() {
    try {
        const response = await fetch('/api/programming_success/{{ distribution.access_token }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            console.error('Failed to mark programming as successful');
        } else {
            console.log('Programming marked as successful in database');
        }
    } catch (error) {
        console.error('Error marking programming success:', error);
    }
}

function showError(message) {
    document.getElementById('nfcInterface').style.display = 'none';
    document.getElementById('errorText').textContent = message;
    document.getElementById('errorMessage').style.display = 'block';
}
</script>
{% endblock %}
